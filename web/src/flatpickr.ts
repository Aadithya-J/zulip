import {formatISO} from "date-fns";
import flatpickr from "flatpickr";
import confirmDatePlugin from "flatpickr/dist/plugins/confirmDate/confirmDate";
import $ from "jquery";
import assert from "minimalistic-assert";
import * as z from "zod/mini";
import {getWeekStartByLocale} from "weekstart";

import {$t} from "./i18n.ts";
import {user_settings} from "./user_settings.ts";
import * as util from "./util.ts";

export let flatpickr_instance: flatpickr.Instance | undefined;

export function is_open(): boolean {
    return Boolean(flatpickr_instance?.isOpen);
}

function is_numeric_key(key: string): boolean {
    return ["0", "1", "2", "3", "4", "5", "6", "7", "8", "9"].includes(key);
}

type Weekday0to6 = 0 | 1 | 2 | 3 | 4 | 5 | 6;

type LocaleWithWeekInfo = Intl.Locale & {
    getWeekInfo: () => {firstDay: unknown};
};

const firstDaySchema = z.union([
    z.literal(1),
    z.literal(2),
    z.literal(3),
    z.literal(4),
    z.literal(5),
    z.literal(6),
    z.literal(7),
]);

const weekdaySchema = z.union([
    z.literal(0),
    z.literal(1),
    z.literal(2),
    z.literal(3),
    z.literal(4),
    z.literal(5),
    z.literal(6),
]);

const weekInfoSchema = z.object({
    firstDay: firstDaySchema,
});

function parseWeekday(value: number): Weekday0to6 | undefined {
    const result = weekdaySchema.safeParse(value);
    if (result.success) {
        return result.data;
    }
    return undefined;
}

function hasGetWeekInfo(loc: Intl.Locale): loc is LocaleWithWeekInfo {
    // eslint-disable-next-line @typescript-eslint/consistent-type-assertions
    return typeof (loc as {getWeekInfo?: unknown}).getWeekInfo === "function";
}

function getNavigatorLocale(): string | undefined {
    if (typeof navigator === "undefined") {
        return undefined;
    }
    // navigator.language returns the browser's UI language, e.g. "en-US".
    return navigator.languages?.[0] ?? navigator.language;
}

export function get_first_day_of_week(): Weekday0to6 {
    switch (user_settings.week_starts_on) {
        case 2:
            return 6; // Saturday
        case 3:
            return 0; // Sunday
        case 4:
            return 1; // Monday
    }
    const navigatorLocale = getNavigatorLocale();

    if (navigatorLocale !== undefined) {
        // Intl.Locale.getWeekInfo().firstDay â€“ returns 1..7 (Mon..Sun) (Chrome and Safari)
        try {
            const loc = new Intl.Locale(navigatorLocale);
            if (hasGetWeekInfo(loc)) {
                const weekInfo = weekInfoSchema.safeParse(loc.getWeekInfo());
                if (weekInfo.success) {
                    const normalized = weekInfo.data.firstDay % 7;
                    const weekday = parseWeekday(normalized);
                    if (weekday !== undefined) {
                        return weekday;
                    }
                }
            }
        } catch {
            /* ignore */
        }

        // CLDR-backed fallback (Firefox)
        try {
            const w = getWeekStartByLocale(navigatorLocale) % 7;
            const weekday = parseWeekday(w);
            if (weekday !== undefined) {
                return weekday;
            }
        } catch {
            /* ignore */
        }
    }

    // Final fallback: Sunday
    return 0;
}

export function show_flatpickr(
    element: HTMLElement,
    callback: (time: string) => void,
    default_timestamp: flatpickr.Options.DateOption,
    options: flatpickr.Options.Options = {},
): flatpickr.Instance {
    const $flatpickr_input = $<HTMLInputElement>("<input>").attr("id", "#timestamp_flatpickr");

    const baseLocale: Record<string, unknown> =
        typeof options.locale === "object" && options.locale !== null ? options.locale : {};
    const mergedLocale = {
        ...baseLocale,
        firstDayOfWeek: get_first_day_of_week(),
    };
    const mergedOptions: flatpickr.Options.Options = {
        ...options,
        locale: mergedLocale,
    };

    flatpickr_instance = flatpickr(util.the($flatpickr_input), {
        mode: "single",
        enableTime: true,
        clickOpens: false,
        defaultDate: default_timestamp,
        plugins: [
            confirmDatePlugin({
                showAlways: true,
                confirmText: $t({defaultMessage: "Confirm"}),
                confirmIcon: "",
            }),
        ],
        positionElement: element,
        dateFormat: "Z",
        formatDate: (date) => formatISO(date),
        disableMobile: true,
        time_24hr: user_settings.twenty_four_hour_time,
        minuteIncrement: 1,
        onKeyDown(_selectedDates, _dateStr, instance, event: KeyboardEvent) {
            // See also the keydown handler below.
            //
            // TODO: Add a clear explanation of exactly how key
            // interactions are dispatched; it seems that keyboard
            // logic from this function, the built-in flatpickr
            // onKeyDown function, and the below keydown handler are
            // used, but it's not at all clear in what order they are
            // called, or what the overall control flow is.
            if (event.key === "Tab") {
                // Ensure that tab/shift_tab navigation work to
                // navigate between the elements in flatpickr itself
                // and the confirmation button at the bottom of the
                // popover.
                const elems = [
                    instance.selectedDateElem,
                    instance.hourElement,
                    instance.minuteElement,
                    ...(user_settings.twenty_four_hour_time ? [] : [instance.amPM]),
                    $(".flatpickr-confirm")[0],
                ];
                assert(event.target instanceof HTMLElement);
                const i = elems.indexOf(event.target);
                const n = elems.length;
                const remain = (i + (event.shiftKey ? -1 : 1)) % n;
                const target = elems[Math.floor(remain >= 0 ? remain : remain + n)];
                event.preventDefault();
                event.stopPropagation();
                assert(target !== undefined);
                target.focus();
            } else {
                // Prevent keypresses from propagating to our general hotkey.ts
                // logic. Without this, `Up` will navigate both in the
                // flatpickr instance and in the message feed behind
                // it.
                event.stopPropagation();
            }
        },
        ...mergedOptions,
    });

    const $container = $(flatpickr_instance.calendarContainer);

    $container.on("keydown", (e) => {
        // Main keyboard UI implementation.

        if (is_numeric_key(e.key)) {
            // Let users type numeric values
            return true;
        }

        if (e.key === "Backspace" || e.key === "Delete") {
            // Let backspace or delete be handled normally
            return true;
        }

        if (e.key === "Enter") {
            if (e.target.classList[0] === "flatpickr-day") {
                // use flatpickr's built-in behavior to choose the selected day.
                return true;
            }
            $container.find(".flatpickr-confirm").trigger("click");
        }

        if (e.key === "Escape") {
            flatpickr_instance?.close();
            flatpickr_instance?.destroy();
        }

        if (e.key === "Tab") {
            // Use flatpickr's built-in navigation between elements.
            return true;
        }

        if (["ArrowLeft", "ArrowUp", "ArrowRight", "ArrowDown"].includes(e.key)) {
            // use flatpickr's built-in navigation of the date grid.
            return true;
        }

        e.stopPropagation();
        e.preventDefault();

        return true;
    });

    $container.on("click", ".flatpickr-confirm", () => {
        const time = $flatpickr_input.val();
        assert(typeof time === "string");
        callback(time);
        flatpickr_instance?.close();
        flatpickr_instance?.destroy();
    });
    flatpickr_instance.open();
    assert(flatpickr_instance.selectedDateElem !== undefined);
    flatpickr_instance.selectedDateElem.focus();

    return flatpickr_instance;
}

export function close_all(): void {
    $(".flatpickr-calendar").removeClass("open");
}
